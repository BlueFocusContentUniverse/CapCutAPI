# Use a slim Python base image
FROM python:3.14-slim-trixie

# Accept build arguments for COS credentials
ARG COS_SECRET_ID
ARG COS_SECRET_KEY

ENV PYTHONUNBUFFERED=1 \
    PYTHONDONTWRITEBYTECODE=1 \
    PIP_NO_CACHE_DIR=1 \
    PYTHONIOENCODING=UTF-8 \
    COS_SECRET_ID=${COS_SECRET_ID} \
    COS_SECRET_KEY=${COS_SECRET_KEY}

WORKDIR /app

# Use noninteractive frontend to avoid prompts during build and install ffmpeg
RUN apt-get update && DEBIAN_FRONTEND=noninteractive apt-get install -y --no-install-recommends \
    ffmpeg \
 && rm -rf /var/lib/apt/lists/*

# Copy requirement files first for better caching
COPY requirements.txt ./
COPY requirements-mcp.txt ./

RUN pip install --upgrade pip \
    && pip install -r requirements.txt \
    && pip install -r requirements-mcp.txt

# Copy the rest of the source code
COPY . .

# Copy production environment file (create from .env.prod.example if needed)
COPY .env.prod* ./
RUN if [ -f .env.prod ]; then cp .env.prod .env; else echo "Warning: .env.prod not found, using defaults"; fi

# Create logs directory
RUN mkdir -p logs

# Expose MCP Streamable HTTP port
EXPOSE 3333

# Run standalone FastMCP server
# MCP_PORT can be overridden at runtime (default 3333)
CMD ["sh", "-c", "python mcp_stream_server.py --host 0.0.0.0 --port ${MCP_PORT:-3333}"]



